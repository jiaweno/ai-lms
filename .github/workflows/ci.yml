name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  POSTGRES_VERSION: '15'
  REDIS_VERSION: '7'

jobs:
  # ===========================
  # ðŸ” ä»£ç è´¨é‡æ£€æŸ¥
  # ===========================
  lint:
    name: ðŸ§¹ Lint & Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ðŸ“¥ Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: ðŸ§¹ Lint frontend
        working-directory: ./frontend
        run: |
          npm run lint
          npm run type-check

      - name: ðŸ§¹ Lint backend
        working-directory: ./backend
        run: |
          npm run lint
          npm run type-check

      - name: ðŸŽ¨ Check code formatting
        run: |
          cd frontend && npm run format -- --check
          cd ../backend && npm run format -- --check

  # ===========================
  # ðŸ§ª åŽç«¯æµ‹è¯•
  # ===========================
  test-backend:
    name: ðŸ§ª Backend Tests
    runs-on: ubuntu-latest
    needs: lint
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:${{ env.REDIS_VERSION }}-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: â° Wait for services
        run: |
          echo "Waiting for PostgreSQL..."
          for i in `seq 1 10`; do
            nc -z localhost 5432 && break
            echo "PostgreSQL not ready, sleeping for 5s..."
            sleep 5
          done
          echo "PostgreSQL is ready!"
          
          echo "Waiting for Redis..."
          for i in `seq 1 10`; do
            nc -z localhost 6379 && break
            echo "Redis not ready, sleeping for 5s..."
            sleep 5
          done
          echo "Redis is ready!"

      - name: ðŸ“¥ Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: âš™ï¸ Setup Prisma for tests
        working-directory: ./backend
        run: |
          npx prisma migrate deploy # Apply migrations for test DB
          npx prisma db seed # Seed test data
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db

      - name: ðŸ§ª Run backend tests
        working-directory: ./backend
        run: npm test -- --coverage
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret-for-ci-minimum-32-characters
          NODE_ENV: test

      - name: â¬†ï¸ Upload Coverage Report
        uses: codecov/codecov-action@v3
        with:
          flags: backend
          directory: ./backend/coverage

  # ===========================
  # ðŸ“¦ æž„å»º & éƒ¨ç½² (ä»…åœ¨main/developåˆ†æ”¯pushæ—¶)
  # ===========================
  build-and-deploy:
    name: ðŸ—ï¸ Build & Deploy
    runs-on: ubuntu-latest
    needs: [lint, test-backend]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: |
          cd frontend && npm ci
          cd ../backend && npm ci

      - name: ðŸ—ï¸ Build applications
        run: |
          cd frontend && npm run build
          cd ../backend && npm run build

      - name: ðŸ“¦ Create release archive
        run: |
          mkdir release
          cp -r frontend/dist release/frontend
          cp -r backend/dist release/backend
          cp -r backend/prisma release/ # Include prisma schema for migrations
          cp docker-compose.prod.yml release/
          tar -czf ai-lms-${{ github.ref_name }}.tar.gz release/

      - name: ðŸ“ Generate changelog
        id: changelog
        run: |
          echo "## Changes in ${{ github.ref_name }}" > CHANGELOG.md
          git log --oneline --no-merges $(git describe --tags --abbrev=0 HEAD^)..HEAD >> CHANGELOG.md

      - name: ðŸš€ Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref_name }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false

      - name: ðŸ“¦ Upload release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./ai-lms-${{ github.ref_name }}.tar.gz
          asset_name: ai-lms-${{ github.ref_name }}.tar.gz
          asset_content_type: application/gzip
